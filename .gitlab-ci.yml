image: hello-world:latest

stages:
  - build-img
  - test

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID               # Execute jobs in merge request context
    - if: $CI_COMMIT_BRANCH == 'develop'     # Execute jobs when a new commit is pushed to master branch

variables:
  CC: gcc
  CXX: g++
  ENABLE_MPI: "1"
  ENABLE_OMP: "0"
  FC: gfortran
  GIT_DEPTH: "100"
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: recursive
  SCCACHE_BUCKET: exa-sccache
  SCCACHE_REGION: us-west-2

.build-test-env: &build_test_env_template
  stage: build-img
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --cache=true --context $CI_PROJECT_DIR --dockerfile $DOCKERFILE --destination $CI_REGISTRY_IMAGE/$IMGTAG:$CI_COMMIT_SHA
  tags:
    - docker

build-nvcc-env:
  variables:
    DOCKERFILE: .gitlab/ci_img_nvcc/Dockerfile
    IMGTAG: nvcc
  <<: *build_test_env_template

###### Test jobs #####

.test: &test_template
  stage: test
  artifacts:
    name: $CI_JOB_NAME
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/
  only:
    - schedules

.build_gpu: &build_gpu
  stage: test
  artifacts:
    name: $CI_JOB_NAME
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/
  only:
    - develop

build:dpcpp:
  variables:
    CC: clang
    CXX: dpcpp
  script:
    - source /opt/intel/oneapi/setvars.sh
    - git submodule update --init --force
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=None
            -DMFIX_GPU_BACKEND=SYCL
            -DSKIP_LAUNCHER=1
            -G Ninja
    - cmake --build build
  <<: *build_gpu
  tags:
    - ubuntu-shell

build:hip:
  variables:
    CXX: hipcc
  script:
    - source /etc/profile.d/rocm.sh
    - git submodule update --init --force
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=None
            -DMFIX_GPU_BACKEND=HIP
            -DAMReX_AMD_ARCH=gfx908
            -G Ninja
    - cmake --build build
  <<: *build_gpu
  allow_failure: true
  tags:
    - ubuntu-shell

build:nvcc:
  variables:
    CC: gcc-9
    CXX: g++-9
  script:
    - sccache -s
    - git submodule update --init --force
    - cmake -S .  -B build
            -DAMReX_CUDA_ARCH=Volta
            -DCMAKE_BUILD_TYPE=None
            -DCMAKE_CUDA_ARCHITECTURES=70
            -DMFIX_CSG=ON
            -DMFIX_GPU_BACKEND=CUDA
            -GNinja
    - cmake --build build
  <<: *build_gpu
  tags:
    - ubuntu-shell

build:csg:
  image: $CI_REGISTRY_IMAGE/nvcc
  needs: ['build-nvcc-env']
  script:
    - sccache -s
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=Debug
            -DMFIX_CSG=ON
    - cmake --build build --target functional_tests
    - ./build/src/eb/tests/functional_tests
  <<: *build_gpu
  tags:
    - ubuntu-shell

.ctest: &ctest_template
  image: $CI_REGISTRY_IMAGE/nvcc
  script:
    - sccache -s
    - git submodule update --init --force
    - cmake -S .
            -B build
            -DMFIX_MPI=$ENABLE_MPI
            -DMFIX_OMP=$ENABLE_OMP
            -G Ninja
    - cmake --build build --target build_tests
    - cd build
    - srun ctest -R $CTEST_LABEL
  tags:
    - docker
  <<: *test_template

test:single-serial:
  variables:
    CTEST_LABEL: SGS
  <<: *ctest_template

test:multiple-serial:
  variables:
    CTEST_LABEL: MGS
  <<: *ctest_template

test:tiled-serial:
  variables:
    CTEST_LABEL: TGS
  <<: *ctest_template

test:multiple-parallel:
  variables:
    CTEST_LABEL: MGP
    OMPI_MCA_rmaps_base_oversubscribe: 1
  <<: *ctest_template

test:tiled-parallel-openmp:
  variables:
    ENABLE_MPI: 0
    ENABLE_OMP: 1
    CTEST_LABEL: TGP
  <<: *ctest_template


.lint: &lint_template
  stage: test
  needs: ['build-nvcc-env']
  image: $CI_REGISTRY_IMAGE/nvcc
  tags:
    - docker
  allow_failure: true

lint:shellcheck:
  <<: *lint_template
  script:
    - find . -name "*.sh" -not -path "./subprojects/*" | xargs shellcheck -e SC2086,SC2125,SC2046,SC2129,SC2044

lint:warnings:
  <<: *lint_template
  script:
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_CXX_FLAGS="-Wall -Wextra -Wnull-dereference -Werror"
            -GNinja
    - cmake --build build -- -k0

lint:spelling:
  <<: *lint_template
  script:
    - rm -rf subprojects
    - codespell --ignore-words-list ba,blocs,inout,ith,od,wen --enable-colors --quiet-level 2
