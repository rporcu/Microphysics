# cache:
#   key: "$CI_BUILD_REF_NAME"
#   untracked: true
#   paths:
#     - build/

# image: mfixexa

variables:
  CTEST_OUTPUT_ON_FAILURE: "1"
  LD_LIBRARY_PATH: "/nfs/apps/MPI/openmpi/1.10.2/gnu/6.1.0/lib:/nfs/apps/Compilers/GNU/6.1.0/lib64:/nfs/apps/Compilers/GNU/6.1.0/lib"
  MPI_CC: "/nfs/apps/MPI/openmpi/1.10.2/gnu/6.1.0/bin/mpicc"
  MPI_CXX: "/nfs/apps/MPI/openmpi/1.10.2/gnu/6.1.0/bin/mpic++"
  MPI_FC: "/nfs/apps/MPI/openmpi/1.10.2/gnu/6.1.0/bin/mpifort"
  CC: "/nfs/apps/Compilers/GNU/6.1.0/bin/gcc"
  CXX: "/nfs/apps/Compilers/GNU/6.1.0/bin/g++"
  FC: "/nfs/apps/Compilers/GNU/6.1.0/bin/gfortran"
  MFIX_BENCHMARKS_HOME: "/nfs/home/0/users/jenkins/exa-benchmarks/MFIX-benchmarks"


.test: &test_template
  script:
    - mkdir build
    - cd build
    - env F77=$FC F90=$FC cmake -DENABLE_MPI=$ENABLE_MPI -DENABLE_OpenMP=$ENABLE_OpenMP ..
    - make -j 4
    - ctest -R $TEST_REGEX
  tags:
    - joule


fld-test-serial:
  variables:
    ENABLE_MPI: "0"
    ENABLE_OpenMP: "0"
    TEST_REGEX: "FLD"
  <<: *test_template

fld-test-mpi:
  variables:
    ENABLE_MPI: "1"
    ENABLE_OpenMP: "0"
    CC: "$MPI_CC"
    CXX: "$MPI_CXX"
    FC: "$MPI_FC"
    TEST_REGEX: "FLD0[1-3]"
  <<: *test_template

.fld-test-openmp:
  variables:
    ENABLE_MPI: "0"
    ENABLE_OpenMP: "1"
    TEST_REGEX: "FLD"
  <<: *test_template


dem-test-serial:
  variables:
    ENABLE_MPI: "0"
    ENABLE_OpenMP: "0"
    TEST_REGEX: "DEM"
  <<: *test_template

.dem-test-openmp:
  variables:
    ENABLE_MPI: "0"
    ENABLE_OpenMP: "1"
    TEST_REGEX: "DEM"
  <<: *test_template
