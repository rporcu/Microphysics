image: mwm126/mfix-exa:cuda

before_script:
  - mkdir -p ccache
  - export CCACHE_BASEDIR=${CI_PROJECT_DIR}
  - export CCACHE_DIR=${CI_PROJECT_DIR}/ccache

cache:
  key: ${CI_JOB_NAME}
  paths:
    - ccache/

variables:
  AMREX_HOME: "${CI_PROJECT_DIR}/amrex_install"
  CC: "gcc"
  CXX: "g++"
  ENABLE_MPI: "1"
  ENABLE_OMP: "0"
  FC: "gfortran"
  GIT_DEPTH: 1
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: normal

###### Test jobs #####

.test_job: &test_template
  tags:
    - mfix-exa
  artifacts:
    name: "$CI_JOB_NAME"
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/
  retry: 2

.cpu_test: &cpu_template
  script:
    - git submodule update --init
    - cmake -S .
            -B build
            -DENABLE_MPI=$ENABLE_MPI
            -DENABLE_OMP=$ENABLE_OMP
    - cmake --build build --target build_tests -j2 --verbose
    - cd build
    - $CTEST_CMD
  <<: *test_template

.gpu_test: &gpu_template
  script:
    - git submodule update --init
    - cmake -S .
            -B build
            -DENABLE_CUDA=1
            -DENABLE_MPI=$ENABLE_MPI
            -DENABLE_OMP=$ENABLE_OMP
    - cmake --build build --target build_tests -j2 --verbose
    - cd build
    - $CTEST_CMD
  <<: *test_template


#  CPU tests

single-grid-serial-cpu:
  variables:
    CTEST_CMD: "srun ctest -R SGS"
  <<: *cpu_template

multiple-grid-serial-cpu:
  variables:
    CTEST_CMD: "srun ctest -R MGS"
  <<: *cpu_template

tiled-grid-serial-cpu:
  variables:
    CTEST_CMD: "srun ctest -R TGS"
  <<: *cpu_template

multiple-grid-parallel-cpu:
  variables:
    CTEST_CMD: "srun ctest -R MGP"
  <<: *cpu_template

tiled-grid-parallel-openmp-cpu:
  variables:
    ENABLE_MPI: "0"
    ENABLE_OMP: "1"
    CTEST_CMD: "srun ctest -R TGP"
  <<: *cpu_template


#  GPU tests

.single-grid-serial-gpu:
  variables:
    CTEST_CMD: "srun ctest -R SGS"
  <<: *gpu_template

.multiple-grid-serial-gpu:
  variables:
    CTEST_CMD: "srun ctest -R MGS"
  <<: *gpu_template

.tiled-grid-serial-gpu:
  variables:
    CTEST_CMD: "srun ctest -R TGS"
  <<: *gpu_template

.multiple-grid-parallel-gpu:
  variables:
    CTEST_CMD: "srun ctest -R MGP"
  <<: *gpu_template

.tiled-grid-parallel-openmp-gpu:
  variables:
    ENABLE_MPI: "0"
    ENABLE_OMP: "1"
    CTEST_CMD: "srun ctest -R TGP"
  <<: *gpu_template
