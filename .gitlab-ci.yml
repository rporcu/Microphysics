image: mwm126/mfix-exa:latest

before_script:
  - mkdir -p ccache
  - export CCACHE_BASEDIR=${CI_PROJECT_DIR}
  - export CCACHE_DIR=${CI_PROJECT_DIR}/ccache

cache:
  key: ${CI_JOB_NAME}
  paths:
    - ccache/

variables:
  AMREX_HOME: "${CI_PROJECT_DIR}/amrex_install"
  CC: "gcc"
  CXX: "g++"
  ENABLE_MPI: "0"
  ENABLE_OMP: "0"
  FC: "gfortran"
  GIT_DEPTH: 1
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: normal

###### Test jobs #####

.test_job: &test_template
  script:
    - git submodule update --init
    - cmake -S .
            -B build
            -DENABLE_MPI=$ENABLE_MPI
            -DENABLE_OMP=$ENABLE_OMP
    - make -C build mfix -j2
    - cd build
    - make build_tests -j2
    - $CTEST_CMD
  tags:
    - mfix-exa
  artifacts:
    name: "$CI_JOB_NAME"
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/
  retry: 2

single-grid-serial:
  variables:
    CTEST_CMD: "srun ctest -R SGS"
  <<: *test_template

multiple-grid-serial:
  variables:
    CTEST_CMD: "srun ctest -R MGS"
  <<: *test_template

tiled-grid-serial:
  variables:
    CTEST_CMD: "srun ctest -R TGS"
  <<: *test_template


multiple-grid-parallel:
  variables:
    CC: "mpicc"
    CXX: "mpic++"
    ENABLE_MPI: "1"
    FC: "mpifort"
    CTEST_CMD: "sbatch -W ${CI_PROJECT_DIR}/.slurm-mgp"
  <<: *test_template


tiled-grid-parallel-openmp:
  variables:
    ENABLE_OMP: "1"
    CTEST_CMD: "srun ctest -R TGP"
  <<: *test_template
