# cache:
#   key: "$CI_BUILD_REF_NAME"
#   untracked: true
#   paths:
#     - build/

# image: mfixexa
image: mwm126/anaconda3:latest

variables:
  CC: "gcc"
  CXX: "g++"
  ENABLE_MPI: "0"
  ENABLE_OMP: "0"
  FC: "gfortran"

.test: &test_template
  script:
    - mkdir build
    - cd build
    - env F77=$FC F90=$FC cmake -DENABLE_MPI=$ENABLE_MPI -DENABLE_OMP=$ENABLE_OMP ..
    - make -j 4
    - cd mfix
    - ctest -R $TEST_REGEX
  only:
    - develop
  tags:
    - docker
  retry: 2


single-grid-serial:
  variables:
    TEST_REGEX: "SGS"
  <<: *test_template

multiple-grid-serial:
  variables:
    TEST_REGEX: "MGS"
  <<: *test_template

multiple-grid-parallel:
  variables:
    CC: "mpicc"
    CXX: "mpic++"
    ENABLE_MPI: "1"
    FC: "mpifort"
    TEST_REGEX: "MGP"
  <<: *test_template

tiled-grid-serial:
  variables:
    TEST_REGEX: "TGS"
  <<: *test_template

tiled-grid-parallel-openmp:
  variables:
    ENABLE_OMP: "1"
    TEST_REGEX: "TGP"
  <<: *test_template
