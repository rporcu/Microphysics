image: mwm126/mfix-exa:20200809

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID               # Execute jobs in merge request context
    - if: $CI_COMMIT_BRANCH == 'develop'     # Execute jobs when a new commit is pushed to master branch

variables:
  CC: gcc
  CXX: g++
  ENABLE_MPI: 1
  ENABLE_OMP: 0
  FC: gfortran
  GIT_DEPTH: 100
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: none

###### Test jobs #####

test:csg: &test_template
  script:
    - git submodule update --init --force
    - cmake -S .
            -B build
            -G Ninja
            -DCMAKE_BUILD_TYPE=Debug
            -DENABLE_CSG=yes
    - cmake --build build --target functional_tests
    - ./build/src/eb/tests/functional_tests
  tags:
    - mfix-exa
  allow_failure: true
  artifacts:
    name: $CI_JOB_NAME
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/

.test_job: &test_template
  artifacts:
    name: $CI_JOB_NAME
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/

.test: &test_template
  script:
    - git submodule update --init --force subprojects/amrex
    - cmake -S .
            -B build
            -DENABLE_MPI=$ENABLE_MPI
            -DENABLE_OMP=$ENABLE_OMP
            -G Ninja
    - cmake --build build --target build_tests
    - cd build
    - $CTEST_CMD
  tags:
    - mfix-exa
  <<: *test_template

build:gpu:
  script:
    - git submodule update --init --force
    - cmake -S .
            -B build
            -DCUDA_ARCH=Volta
            -DENABLE_CSG=yes
            -DENABLE_CUDA=1
            -DENABLE_MPI=$ENABLE_MPI
            -DENABLE_OMP=$ENABLE_OMP
            -G Ninja
    - cmake --build build --target build_tests
  tags:
    - mfix-exa
  <<: *test_template


test:single-serial:
  variables:
    CTEST_CMD: srun ctest -R SGS
  <<: *test_template

test:multiple-serial:
  variables:
    CTEST_CMD: srun ctest -R MGS
  <<: *test_template

test:tiled-serial:
  variables:
    CTEST_CMD: srun ctest -R TGS
  <<: *test_template

test:multiple-parallel:
  variables:
    CTEST_CMD: srun ctest -R MGP
  <<: *test_template

test:tiled-parallel-openmp:
  variables:
    ENABLE_MPI: 0
    ENABLE_OMP: 1
    CTEST_CMD: srun ctest -R TGP
  <<: *test_template


linter:shellcheck:
  script:
    - wget https://github.com/koalaman/shellcheck/releases/download/stable/shellcheck-stable.linux.x86_64.tar.xz
    - tar xf shellcheck-stable.linux.x86_64.tar.xz
    - find . -name "*.sh" -not -path "./subprojects/*" | xargs shellcheck-stable/shellcheck -e SC2086,SC2125,SC2046,SC2129,SC2044
  tags:
    - mfix-exa
  allow_failure: true

linter:warnings:
  script:
    - cmake -S . -B build -DCMAKE_CXX_FLAGS="-Wall -Werror" -DCMAKE_Fortran_FLAGS="-O0" -GNinja
    - cmake --build build -- -k0
  tags:
    - mfix-exa
  allow_failure: true

linter:spelling:
  script:
    - rm -rf subprojects
    - codespell --ignore-words-list ba,blocs,inout,ith,od,wen --enable-colors --quiet-level 2
  allow_failure: true
  except:
    - schedules
  tags:
    - mfix-exa
