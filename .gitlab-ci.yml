image: hello-world:latest

stages:
  - build-img
  - test

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID               # Execute jobs in merge request context
    - if: $CI_COMMIT_BRANCH == 'develop'     # Execute jobs when a new commit is pushed to master branch

variables:
  CC: gcc
  CXX: g++
  ENABLE_MPI: "1"
  ENABLE_OMP: "0"
  FC: gfortran
  GIT_DEPTH: "100"
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: recursive
  SCCACHE_BUCKET: exa-sccache
  SCCACHE_REGION: us-west-2

.build-test-env: &build_test_env_template
  stage: build-img
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --cache=true --context $CI_PROJECT_DIR --dockerfile $DOCKERFILE --destination $CI_REGISTRY_IMAGE/$IMGTAG:$CI_COMMIT_TAG
  tags:
    - docker

.build-dpcpp-env:
  variables:
    DOCKERFILE: .gitlab/ci_img_dpcpp/Dockerfile
    IMGTAG: dpcpp
  <<: *build_test_env_template

.build-hip-env:
  variables:
    DOCKERFILE: .gitlab/ci_img_hip/Dockerfile
    IMGTAG: hip
  <<: *build_test_env_template

build-nvcc-env:
  variables:
    DOCKERFILE: .gitlab/ci_img_nvcc/Dockerfile
    IMGTAG: nvcc
  <<: *build_test_env_template

###### Test jobs #####

.test: &test_template
  stage: test
  artifacts:
    name: $CI_JOB_NAME
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/
  tags:
    - docker

.testcsg: &test_gpu
  stage: test
  artifacts:
    name: $CI_JOB_NAME
    expire_in: 1 week
    when: on_failure
    paths:
      - build/Testing/
  tags:
    - docker
  allow_failure: true

.test:dpcpp:
  variables:
    CC: clang
    CXX: dpcpp
  image: intel/oneapi-hpckit:2021.1-devel-ubuntu18.04
  # needs: ['build-dpcpp-env']
  script:
    - ls /
    - ls /opt
    - source /opt/intel/oneapi/setvars.sh
    - git submodule update --init --force
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=Debug
            -DMFIX_GPU_BACKEND=SYSCL
    - cmake --build build
  <<: *test_gpu

.test:hip:
  variables:
    CC: hipcc
    CXX: hipcc
  image: $CI_REGISTRY_IMAGE:hip
#   needs: ['build-hip-env']
  script:
    - source /etc/profile.d/rocm.sh
    - git submodule update --init --force
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=Debug
            -DMFIX_GPU_BACKEND=HIP
    - cmake --build build
  <<: *test_gpu

test:nvcc:
  image: $CI_REGISTRY_IMAGE/nvcc
  needs: ['build-nvcc-env']
  script:
    - sccache -s
    - git submodule update --init --force
    - cmake -S .
            -B build
            -DAMReX_CUDA_ARCH=Volta
            -DCMAKE_BUILD_TYPE=None
            -DCMAKE_CUDA_ARCHITECTURES=70
            -DMFIX_GPU_BACKEND=CUDA
    - cmake --build build
  <<: *test_gpu

test:csg:
  image: $CI_REGISTRY_IMAGE/nvcc
  needs: ['build-nvcc-env']
  script:
    - sccache -s
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=Debug
            -DMFIX_CSG=ON
    - cmake --build build --target functional_tests
    - ./build/src/eb/tests/functional_tests
  <<: *test_gpu

.ctest: &ctest_template
  image: $CI_REGISTRY_IMAGE/nvcc
  script:
    - sccache -s
    - git submodule update --init --force subprojects/amrex
    - cmake -S .
            -B build
            -DMFIX_MPI=$ENABLE_MPI
            -DMFIX_OMP=$ENABLE_OMP
            -G Ninja
    - cmake --build build --target build_tests
    - cd build
    - $CTEST_CMD
  <<: *test_template

test:single-serial:
  variables:
    CTEST_CMD: srun ctest -R SGS
  <<: *ctest_template

test:multiple-serial:
  variables:
    CTEST_CMD: srun ctest -R MGS
  <<: *ctest_template

test:tiled-serial:
  variables:
    CTEST_CMD: srun ctest -R TGS
  <<: *ctest_template

test:multiple-parallel:
  variables:
    CTEST_CMD: srun ctest -R MGP
    OMPI_MCA_rmaps_base_oversubscribe: 1
  <<: *ctest_template

test:tiled-parallel-openmp:
  variables:
    ENABLE_MPI: 0
    ENABLE_OMP: 1
    CTEST_CMD: srun ctest -R TGP
  <<: *ctest_template


linter:shellcheck:
  stage: test
  image: $CI_REGISTRY_IMAGE/nvcc
  script:
    - find . -name "*.sh" -not -path "./subprojects/*" | xargs shellcheck -e SC2086,SC2125,SC2046,SC2129,SC2044
  tags:
    - docker
  allow_failure: true

linter:warnings:
  stage: test
  image: $CI_REGISTRY_IMAGE/nvcc
  needs: ['build-nvcc-env']
  script:
    - cmake -S .
            -B build
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_CXX_FLAGS="-Wall -Werror"
            -GNinja
    - cmake --build build -- -k0
  tags:
    - docker
  allow_failure: true

linter:spelling:
  stage: test
  image: $CI_REGISTRY_IMAGE/nvcc
  needs: ['build-nvcc-env']
  script:
    - rm -rf subprojects
    - codespell --ignore-words-list ba,blocs,inout,ith,od,wen --enable-colors --quiet-level 2
  allow_failure: true
  except:
    - schedules
  tags:
    - docker
