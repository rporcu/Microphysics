# cache:
#   key: "$CI_BUILD_REF_NAME"
#   untracked: true
#   paths:
#     - build/

# image: mfixexa

stages:
  - build
  - test
  - benchmarks

variables:
  CTEST_OUTPUT_ON_FAILURE: "1"
  LD_LIBRARY_PATH: "/nfs/apps/Compilers/GNU/6.1.0/lib:/nfs/apps/Compilers/GNU/6.1.0/lib64"
  BOXLIB_HOME: "/nfs/home/0/users/jenkins/amrex"
  GCC_BIN_DIR: "/nfs/apps/Compilers/GNU/6.1.0/bin/"

build:
  stage: build
  script:
    - mkdir build
    - cd build
    - FC="${GCC_BIN_DIR}/gfortran" CC="${GCC_BIN_DIR}/gcc" CXX="${GCC_BIN_DIR}/g++" cmake ..
    - make
  artifacts:
    expire_in: 1 day
    paths:
    - build

test:
  stage: test
  script:
    - cd build
    - make build_test
    - ctest -R tests

benchmarks:
  stage: benchmarks
  script:
    - mkdir build-benchmarks
    - cd build-benchmarks
    - FC="${GCC_BIN_DIR}/gfortran" CC="${GCC_BIN_DIR}/gcc" CXX="${GCC_BIN_DIR}/g++" cmake -DCMAKE_BUILD_TYPE=Release ..
    - ctest -R benchmarks
