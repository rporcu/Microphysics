image: mwm126/anaconda3:latest

stages:
  - build
  - test

variables:
  AMREX_HOME: "${CI_PROJECT_DIR}/amrex_install"
  CC: "gcc"
  CXX: "g++"
  ENABLE_MPI: "0"
  ENABLE_OMP: "0"
  FC: "gfortran"
  GIT_DEPTH: 1
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: normal

###### Build jobs #####

.build: &build_template
  stage: build
  tags:
    - docker
  script:
    - git submodule update --init
    - cmake -S subprojects/amrex
            -B amrex_build
            -DENABLE_PARTICLES=1
            -DENABLE_AMRDATA=1
            -DENABLE_EB=1
            -DENABLE_3D_NODAL_MLMG=1
            -DENABLE_MPI=$ENABLE_MPI
            -DENABLE_OMP=$ENABLE_OMP
            -DCMAKE_INSTALL_PREFIX:PATH=$AMREX_HOME
    - make -C amrex_build install -j 4
    - cmake -S .
            -B build
            -DENABLE_MPI=$ENABLE_MPI
            -DENABLE_OMP=$ENABLE_OMP
            -DAMREX_INSTALL_DIR=$AMREX_HOME
    - make -C build -j 4
  artifacts:
    name: "$CI_JOB_NAME"
    expire_in: 1 week
    paths:
      - amrex_install/
      - build

build-serial:
  <<: *build_template

build-mpi:
  variables:
    CC: "mpicc"
    CXX: "mpic++"
    ENABLE_MPI: "1"
    FC: "mpifort"
  <<: *build_template

build-openmp:
  variables:
    ENABLE_OMP: "1"
  <<: *build_template


###### Test jobs #####

.test_job: &test_template
  stage: test
  script:
    - cd build
    - ctest -R $TEST_REGEX
  allow_failure: true
  only:
    - develop
  tags:
    - docker

.test_serial: &serial_test_template
  <<: *test_template
  dependencies:
    - build-serial

single-grid-serial:
  variables:
    TEST_REGEX: "SGS"
  <<: *serial_test_template

multiple-grid-serial:
  variables:
    TEST_REGEX: "MGS"
  <<: *serial_test_template

tiled-grid-serial:
  variables:
    TEST_REGEX: "TGS"
  <<: *serial_test_template


.test_parallel: &parallel_test_template
  <<: *test_template
  dependencies:
    - build-mpi

multiple-grid-parallel:
  variables:
    TEST_REGEX: "MGP"
  <<: *parallel_test_template


.test_openmp: &openmp_test_template
  <<: *test_template
  dependencies:
    - build-openmp

tiled-grid-parallel-openmp:
  variables:
    ENABLE_OMP: "1"
    TEST_REGEX: "TGP"
  <<: *openmp_test_template
