# cache:
#   key: "$CI_BUILD_REF_NAME"
#   untracked: true
#   paths:
#     - build/

# image: mfixexa

stages:
  - build
  - test
  - benchmarks

variables:
  CTEST_OUTPUT_ON_FAILURE: "1"
  INTEL_LICENSE_FILE: "/nfs/apps/Compilers/Intel/ParallelStudio/2016.3.067/licenses/COM_L___9CX2-WF9RXD5G.lic"
  LD_LIBRARY_PATH: "/nfs/apps/Compilers/GNU/6.1.0/lib:/nfs/apps/Compilers/GNU/6.1.0/lib64:/nfs/apps/Compilers/Intel/ParallelStudio/2016.2.062/lib/intel64"
  BOXLIB_HOME: "/nfs/home/0/users/jenkins/BoxLib"

build:
  stage: build
  script:
    - mkdir build
    - cd build
    # - FC='mpifort -g -std=f2008 -fcheck=all -Wall' cmake -DMPI=1 -DSMP=1 ..
    - FC='/nfs/apps/Compilers/GNU/6.1.0/bin/gfortran -g -std=f2008 -fcheck=all -Wall -Wextra -Wimplicit-interface -Wuse-without-only' CC='/nfs/apps/Compilers/GNU/6.1.0/bin/gcc -g -Wall' CXX='/nfs/apps/Compilers/GNU/6.1.0/bin/g++ -g -Wall' cmake ..
    - make
    - ctest -R build_
  artifacts:
    expire_in: 1 week
    paths:
    - build

# build_intel:
#   stage: build
#   script:
#     - mkdir build_intel
#     - cd build_intel
#     # - FC='mpifort -g -std=f2008 -fcheck=all -Wall' cmake -DMPI=1 -DSMP=1 ..
#     - env FC="/nfs/apps/Compilers/Intel/ParallelStudio/2016.3.067/bin/ifort -g -stand f08 -check all -warn all" cmake ..
#     - make
#     - ctest -R build_

test:
  stage: test
  script:
    - cd build
    - ctest -R tests

benchmarks:
  stage: benchmarks
  script:
    - mkdir build-benchmarks
    - cd build-benchmarks
    - FC='/nfs/apps/Compilers/GNU/6.1.0/bin/gfortran -g -std=f2008 -Wall' CC='/nfs/apps/Compilers/GNU/6.1.0/bin/gcc -g -Wall' CXX='/nfs/apps/Compilers/GNU/6.1.0/bin/g++ -g -Wall' cmake -DCMAKE_BUILD_TYPE=Release ..
    - ctest -R benchmarks
